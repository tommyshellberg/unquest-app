appId: com.vaedros.unquest.development
---
- clearState
# Unset notifications permission to ensure consistent test state
- launchApp:
    permissions:
      notifications: unset

# =============================================================================
# DEVELOPMENT ENVIRONMENT SETUP
# =============================================================================
# Handle development-specific screens that appear before the actual app loads

# Handle development server selection (if it appears)
- runFlow:
    when:
      visible: 'http://10.0.2.2:8081'
    commands:
      - assertVisible: 'Development servers'
      - tapOn: 'http://10.0.2.2:8081'

- runFlow:
    when:
      visible: 'http://localhost:8081'
    commands:
      - assertVisible: 'Development servers'
      - tapOn: 'http://localhost:8081'

# Handle Expo development menu if it appears
- runFlow:
    when:
      visible:
        text: '.*developer menu.*'
    commands:
      - tapOn: 'Continue'

- runFlow:
    when:
      visible:
        text: '.*Runtime version.*'
    commands:
      - tapOn: 'Reload'

# Wait for app to load
- waitForAnimationToEnd

# =============================================================================
# COMPLETE ONBOARDING FLOW - FLEXIBLE APPROACH
# =============================================================================
# The app might start at different points, so we handle each case

# SCENARIO 1: App shows intro screen
- runFlow:
    when:
      visible: 'Welcome to unQuest'
    commands:
      - tapOn: 'Got it'
      - waitForAnimationToEnd

# SCENARIO 2: App starts at "Your Journey Begins" quest screen
# This happens if some state persists or in coop mode
- runFlow:
    when:
      visible: 'Your Journey Begins'
    commands:
      # We're already at quest screen, proceed with quest
      - assertVisible: 'Wake up'
      - tapOn: 'Wake up'
      - waitForAnimationToEnd
      # Should now be at pending quest screen
      - assertVisible: 'Quest Ready'
      - assertVisible: 'Lock your phone to begin your quest'
      # Continue with quest flow below

# SCENARIO 3: Normal onboarding flow starting at welcome
- runFlow:
    when:
      visible: 'Level Up By Logging Off'
    commands:
      - assertVisible: 'Begin New Journey'
      - tapOn: 'Begin New Journey'
      - waitForAnimationToEnd

      # Character Name Screen
      - assertVisible: 'Your Character'
      - tapOn: 'Enter character name'
      - inputText: 'MaestroHero'
      - tapOn: 'Continue'
      - waitForAnimationToEnd

      # Character Type Selection
      - assertVisible: 'Select the character that speaks to you'
      - assertVisible: 'ALCHEMIST'
      - tapOn: 'Create Character'
      - waitForAnimationToEnd

      # Handle possible intro screens after character creation
      - runFlow:
          when:
            visible: 'Welcome to unQuest'
          commands:
            - tapOn: 'Got it'
            - waitForAnimationToEnd

      # Handle notifications screen if it appears
      - runFlow:
          when:
            visible: 'Notifications'
          commands:
            - tapOn: 'Enable notifications'
            - waitForAnimationToEnd
            # Handle system permission if it shows
            - runFlow:
                when:
                  visible: '.*Allow.*'
                commands:
                  - tapOn: 'Allow'

      # Should now be at quest screen
      - assertVisible: 'Your Journey Begins'
      - tapOn: 'Wake up'
      - waitForAnimationToEnd

# =============================================================================
# QUEST FLOW - Common path regardless of how we got here
# =============================================================================
# We might be at the quest screen if none of the above scenarios triggered
# This happens when the app opens directly to "Your Journey Begins"
- runFlow:
    when:
      visible: 'Your Journey Begins'
    commands:
      - assertVisible: 'Wake up'
      - tapOn: 'Wake up'
      # Wait longer for navigation
      - waitForAnimationToEnd
      - waitForAnimationToEnd

# At this point we should be at the pending quest screen
- assertVisible: 'Quest Ready'
- assertVisible: 'Lock your phone to begin your quest'

# Lock the device to start the quest
- pressKey: Lock

# =============================================================================
# WAIT FOR QUEST COMPLETION
# =============================================================================
# Wait for quest to complete - using repeat with waitForAnimationToEnd
# In development, quests complete in 2 minutes (120 seconds)
# Using 24 iterations of 5-second waits
- repeat:
    times: 24
    commands:
      - waitForAnimationToEnd

# =============================================================================
# UNLOCK AND VERIFY QUEST COMPLETION
# =============================================================================
# Unlock the device
- pressKey: Lock

# Swipe to unlock (may need adjustment for different devices)
- swipe:
    start: 50%, 80%
    end: 50%, 20%
    duration: 500

# Give app time to detect unlock and show completion
- waitForAnimationToEnd

# Verify quest completion
- assertVisible: 'Quest Complete'
- assertVisible: 'XP Gained'

# Continue from quest completion
- tapOn: 'Continue'
- waitForAnimationToEnd

# =============================================================================
# SIGNUP FLOW AFTER FIRST QUEST
# =============================================================================
- assertVisible: 'Create Account'
- assertVisible: 'Save your progress'

# Complete signup
- tapOn: 'Email'
- inputText: 'testquester@example.com'
- tapOn: 'Create Account'

# Verify email verification screen
- assertVisible: 'Check your email'
- assertVisible: 'testquester@example.com'
# =============================================================================
# TEST COMPLETE
# =============================================================================
# Successfully completed full onboarding flow:
# ✅ Handled different starting points (intro, quest, welcome)
# ✅ Character creation (if needed)
# ✅ Quest start and 2-minute wait
# ✅ Quest completion and XP reward
# ✅ Account creation after first quest

appId: com.vaedros.unquest.staging
---
# =============================================================================
# CONVERT PROVISIONAL USER TO FULL USER
# =============================================================================
# This flow converts the provisional user created during onboarding
# to a full authenticated user by updating the database.
#
# Prerequisites:
#   - Onboarding flow must have completed first
#   - TEST_EMAIL environment variable must be set
#   - MONGODB_URI environment variable must be set
#
# Expected State After:
#   - User is converted to full user (isProvisional: false)
#   - User has completed 1 quest
#   - User has Level 1, 50 XP, Day 1 streak
# =============================================================================

# Stop the app before database modification
- stopApp

# Run conversion script
# Note: TEST_EMAIL and MONGODB_URI are passed via --env flags from run-tests.sh
# Path is relative to the flow file location (flows/02-conversion/)
- runScript: ../../scripts/run-conversion.sh

# Wait a moment for database changes to propagate

# Restart app to reload with full user status
- launchApp

# Wait for app to fully load and hydrate auth state

# =============================================================================
# VERIFY CONVERSION SUCCESS
# =============================================================================
# After conversion, user should be logged in and see the home screen
# (not the onboarding or login screens)

# Handle dev environment screens if they appear
- runFlow:
    when:
      visible: 'Development servers'
    commands:
      - tapOn: 'http://10.0.2.2:8081'

- runFlow:
    when:
      visible: 'Continue'
    commands:
      - tapOn: 'Continue'

- runFlow:
    when:
      visible: 'Go home'
    commands:
      - tapOn: 'Go home'

# Verify we're at the home screen (authenticated state)
- extendedWaitUntil:
    visible: 'Your Journey'
    timeout: 15000

# Verify home screen elements are present
- assertVisible: 'emberglow'

# =============================================================================
# CONVERSION COMPLETE
# =============================================================================
# The provisional user is now a full authenticated user!
# Next tests can proceed with known state:
#   - Level: 1
#   - XP: 50
#   - Quests completed: 1
#   - Streak: Day 1
